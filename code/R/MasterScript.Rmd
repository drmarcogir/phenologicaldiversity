---
title: "Phenology analyses"
output:
  html_document:
    code_folding: hide
    geometry: margin=1cm
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r,load libraries,results='hide',message=FALSE,eval=FALSE,comment='#'}
suppressMessages(library(tidyverse));suppressMessages(library(phenoutils))
suppressMessages(library(gdalUtils));suppressMessages(library(raster))
suppressMessages(library(marcoUtils));library(gridExtra);library(RColorBrewer)
library(ggcorrplot)

```
#### **1. Spatial intercorrelation between pheno metrics (at their native resolution 500m)** This analysis was carried out using GRASS GIS. Processing time was reasonable considering the billions of pixels involved. Correlation matrix based on the pearson's coefficient was only performed only for areas where coverage was complete.
```{r,results='hide',message=FALSE,eval=FALSE,comment='#'}

cor_results<-NULL

pheno.l<-c("Senescence","Peak","MidGreenup","MidGreendown","Maturity","Greenup","Dormancy")

for (i in 2001:2016){
  # compute covariance matrix between maps
  paste0(paste0(paste0(pheno.l,"_",i,"_season1",collapse=","),","),
         paste0(pheno.l,"_",i,"_season2",collapse=","))->phenos
  paste0("r.covar map=",phenos," -r > tmpout")->covmat
  system(command=covmat)
  # delete first row
  system('cat tmpout | sed -e "1d" > tmpout1')
  # read in covariance matrix
  read.table("tmpout1")->df
  # row and column names
  colnames(df)<-str_replace_all(str_split(phenos,",")[[1]],paste0("_",i,"_season"),"")
  row.names(df)<-str_replace_all(str_split(phenos,",")[[1]],paste0("_",i,"_season"),"")
  # only use lower triangular matrix
  df[upper.tri(df,diag=TRUE)]<-NA
  # insert extra column (becomes x axis)
  df$Var1<-row.names(df)
  # long format + year column 
  df %>%
  tidyr::gather(key="Var2",value="value",na.rm=T,-c(Var1)) %>%
  mutate(year=i)->df1
  bind_rows(df1,cor_results)->cor_results
}
#saveRDS(cor_results,"/data2/markdown_intermediate/intercorrelation_500m.RDS")
readRDS("/data2/markdown_intermediate/intercorrelation_500m.RDS")->cor_results


```

```{r,results='hide',message=FALSE,eval=FALSE,comment='#'}
# This code chunk is separate because it takes ages to run the above 
readRDS("/data2/markdown_intermediate/intercorrelation_500m.RDS") %>%
  as_tibble()  %>%
  inner_join(pheno_labels %>%
               rename(Var1=old)) %>%
  rename(Var1_new=new) %>%
  inner_join(pheno_labels %>%
               rename(Var2=old)) %>%
  rename(Var2_new=new) %>%
  mutate(Var1=as_factor(Var1_new),Var2=as_factor(Var2_new)) %>%
  ggplot(.,aes(x=Var1,y=Var2,fill=value))+geom_tile()+facet_wrap(~year,ncol=4)+
    theme_bw()+theme(axis.text.x = element_text(angle=45,hjust=1))+
  scale_fill_distiller(palette="RdBu")+ylab("")+xlab("")->myp1
myp1
#ggplotly(myp1,height=1000,width=800)

```


#### **2. ESA maps only forested areas where there have been no land cover changes**
```{r, results='hide',message=FALSE,eval=FALSE,comment='#'}
system("g.region raster=lc_2001")
system("r.mapcalc 'lc_mask = lc_2001/lc_2001'")
system("r.clump in=lc_mask out=lc_maskc")
# mask out Antarctica
system("r.mask raster=lc_maskc maskcats='288529 thru 291376' -i")
# calculate new map without Antarctica
system("r.mapcalc 'lc_mask1 = lc_mask' --o")
# remove mask
system("r.mask -r")

# create maps of forested areas

paste0("lc_",2001:2015)->maps

system("r.mask -r")
for (i in 1:length(maps)){
  print(maps[i])
  # mask forest categories
  system(command = paste0("r.mask raster=",maps[i]," maskcats=","'50 thru 100'"))
  # calculate forest map
  system(command = paste0("r.mapcalc '", paste0(maps[i],"_for")," = ",maps[i],"/",maps[i],"' --o"))
  system("r.mask -r")
}

# create final mask
system("g.region raster=lc_2001")
system(command = paste0("r.mapcalc 'tmp = ",paste0(maps,"_for",collapse="+"),"' --o"))
# set all pixel values to 1
system(command = paste0("r.mapcalc 'forest_mask1 = tmp/tmp' --o"))
```
#### **3. Create forest mask ** This step of this analysis involves filtering the phenology data using mask of forested areas that have been stable from 2001 until 2016. Please note that the mask had already been created beforehand.
```{r, create forest mask,results='hide',message=FALSE,eval=FALSE,comment='#'}
# i) Interpolate ESA CCI forest mask to a 500m resolution (same as phenology data)
# set region resolution
system("g.region raster=Peak_2005_season1 -p") 
system("r.resamp.interp input=forest_mask output=tmp \
                method=nearest --o")
# Bilinear interpolation
system('r.mapcalc "forest_mask_500m = int(tmp)" --o') 
```
#### **4. Data filtering (for forested areas) ** This step of this analysis involves filtering the phenology data using mask of forested areas that have been stable from 2001 until 2016. 
```{r, filter by forested areas,results='hide',message=FALSE,eval=FALSE,comment='#'}
system("r.mask -r")
system("g.region raster=mask_unchanged_500m")
system("r.mask raster=mask_unchanged_500m maskcats=1")
  # create new raster with forest maps.
  for (i in 1:length(maps_original)){ 
    print(i)
    # create new map masked by forest
    system(command = paste0("r.mapcalc '",maps_original[i],"_for = ",maps_original[i],"' --o"))
    system(command = paste0("r.mapcalc '",maps_original[i],"_for_binary = ",maps_original[i],"' --o"))
}
system("r.mask -r")

# Peak
system(command=paste0("r.series input=",paste0("Peak_",2001:2016,"_season1_for",collapse = ","),
              " output=Peak_compo method=median"))
system("g.region res=0.05")
system("r.resamp.stats in=Peak_compo out=Peak_sd method=stddev")

```

#### **5. PFTs**
##### This step of this analysis involves: i) filter phenology data using mask of forested areas that have been stable from 2001 until 2016. ii) calculating PFTs for 5 km x 5 km squares.
```{r data filtering step,results='hide',message=FALSE,eval=FALSE,comment='#'}
# land cover 2015

# list of pfts
pft.l<-c("BrEv","BrDc","NeEv","NeDe")

pft_prop<-NULL

for (i in 1:4){
  print(pft.l[i])
  # subset pft of interest and create reclass rule file
  pft %>%
    dplyr::filter(PFT==pft.l[i]) %>%
    mutate(rcl=paste0(cat," = ",area_m2)) %>%
    dplyr::select(rcl) %>%
    write.table(.,file="tmp",row.names=F,quote=F,col.names = F)
  # set region
  system("g.region raster=lc_2015")
  # create tmp reclassified map
  system("r.reclass in=lc_2015 out=tmp rules=tmp --o")
  # aggregate map to 5km 
  system("g.region raster=forest_mask_5km") --------------!!!!!!!!!!!!!!!
  system("r.resamp.stats in=tmp method=sum out=tmpsum --o")
  # calculate proportions
  system("r.mapcalc 'tmpfrac = tmpsum /25000000' --o")
  # outputs map
  #system("r.stats -Agn in=tmpfrac,grid5km > tmpfrac")
  #system('r.out.gdal in=tmpfrac out=tmpfrac.tif createopt="COMPRESS=LZW" --o')
  # get raster and convert it into tibble
  #read.table("tmpfrac") %>%
  #  as_tibble() %>%
  #  rename(prop=V1,cat=V2) %>%
  #  mutate(prop=round(prop,digits = 2)) %>%
  #  mutate(prop = ifelse(prop >1,1,prop),PFT=pft.l[i])->tmp

  #bind_rows(tmp,pft_prop)->pft_prop
  # clean up
  #system("rm tmpfrac.tif")
  #system("rm tmp")
  system("rm tmpr1.tif")
  system("r.out.gdal in=tmpfrac out=tmp.tif createopt='compress=LZW' --o")
  system('gdalwarp -s_srs "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs" -t_srs "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs" -r near -of GTiff tmp.tif tmpr1.tif')
  # read in file
  as_tibble(rastertodf(raster("tmpr1.tif")))->tmpdf
  tmpdf %>% rename(prop =value) %>% mutate(prop = ifelse(prop >1,1,prop),PFT=pft.l[i])->tmpdf1
  bind_rows(tmpdf1,pft_prop)->pft_prop
}
saveRDS(pft_prop,file="/home/marco/Desktop/phenology/rds/pft_prop.RDS")
readRDS("/home/marco/Desktop/phenology/rds/pft_prop.RDS")->pft_prop1

pft_prop1 %>% 
  filter(prop > 0.8)->pft_prop2
```

#### **6 Filter by forested areas**
```{r forest area filter,results='hide',message=FALSE,eval=FALSE,comment='#'}
#system("g.region raster=lc_2015_for")
#system("r.stats -lna in=lc_2015_for,grid5km > propfor")
#system("r.stats -lnc in=lc_2015_for,grid5km > propfor1")
#system("cat propfor1 | awk '{print $2\",\"$3}' > forestprop2")
options(scipen=999)
read_csv("forestprop2",col_names=FALSE) %>%
  rename(cat=X1,nocells=X2) %>%
  mutate(prop = nocells/324) %>%
  dplyr::filter(prop > 0.8) %>%
  mutate(rcl = paste0(cat," = ",1)) %>%
  dplyr::select(rcl) %>%
  write.table(.,file="rcl",row.names = F,quote = F,col.names = F)

system("r.reclass in=grid5km out=forest_5km rules=rcl")
system("g.region raster=forest_5km")
system("r.out.gdal in=forest_5km out=/home/marco/Desktop/phenology/tmp/forest_mask_5km.tif createopt='compress=LZW'")
as_tibble(rastertodf(raster("/home/marco/Desktop/phenology/tmp/forest_mask_5km.tif"))) %>%
  rasterFromXYZ()->forest_mask_5km

dplyr::select(-c(value))->forest_mask_5km
```

#### **7. Calculate alternative phenological metrics**
##### This step of this analysis involves calculating a number of alternative phenological metrics including: i) Length of the season ii) Distance from Greenup to Peak. iii) Distance to Greendown to Peak. Peak should also be included.
```{r, alternative phenological metrics,results='hide',message=FALSE,eval=FALSE,comment='#'}
#system("chmod u+x doy.sh")
#system("./doy.sh")

#system("g.list rast | grep for")


years.l<-2001:2016
pheno_new<-NULL


for (i in 1:length(years.l)){
  print(years.l[i])
  # Mapnames Greenup, Dormancy, Peak
  paste0("GUP1_",years.l[i],"_for")->GUP1
  paste0("GUP2_",years.l[i],"_for")->GUP2
  paste0("DO1_",years.l[i],"_for")->DO1
  paste0("DO2_",years.l[i],"_for")->DO2
  paste0("P1_",years.l[i],"_for")->PE1
  paste0("PE2_",years.l[i],"_for")->PE2
  #-- season 1
  # days from greenup to peak
  paste0("GUP1_PE1_",years.l[i])->tmp
  bind_rows(tibble(tmp),pheno_new)->pheno_new
  paste0('r.mapcalc "',tmp,' = ',PE1,' - ',GUP1,'" --o')->calc
  system(command=calc)
  # days from peak to dormancy
  paste0("DO1_PE1_",years.l[i])->tmp
  bind_rows(tibble(tmp),pheno_new)->pheno_new
  paste0('r.mapcalc "',tmp,' = ',DO1,' - ',PE1,'" --o')->calc
  system(command=calc)
  # days from greenup to dormancy
  paste0("GUP1_DO1_",years.l[i])->tmp
  bind_rows(tibble(tmp),pheno_new)->pheno_new
  system(command = paste0('r.mapcalc "',tmp,' = ',DO1,' - ',GUP1,'" --o'))
  #system(command=paste0("r.stats -ln ",tmp),intern = T)->dd
  #-- season 2
  # days from greenup to peak
  paste0("GUP2_PE2_",years.l[i])->tmp
  bind_rows(tibble(tmp),pheno_new)->pheno_new
  paste0('r.mapcalc "',tmp,' = ',PE2,' - ',GUP2,'" --o')->calc
  system(command=calc)
  # days from peak to dormancy
  paste0("DO2_PE2_",years.l[i])->tmp
  bind_rows(tibble(tmp),pheno_new)->pheno_new
  paste0('r.mapcalc "',tmp,' = ',DO2,' - ',PE2,'" --o')->calc
  system(command=calc)
}

system("g.list rast | grep _for | grep P | grep -v MGUP2_ | grep -v GUP1 | grep -v GUP2",inter=TRUE)->tmp
tibble(tmp) %>%
  bind_rows(pheno_new)->pheno_new
save(pheno_new,file="/data2/scripts/phenoutils/data/pheno_new.rda")

```
#### **8. Create maps phenological metrics
```{r, quick and dirty maps,results='hide',message=FALSE,eval=FALSE,comment='#'}
load("/data2/scripts/phenoutils/data/pheno_new.rda")
system("d.erase")
maps.l<-pheno_new$tmp
for (i in 1:length(maps.l)){
  # map on screen
  system(command = paste0("d.rast ",maps.l[i]))
  system("d.vect world fcolor=none")
  Sys.sleep(5)
  # save map
  system(command=paste0("d.out.file  output=/data2/figures/",maps.l[i]," format=png"))
  Sys.sleep(5)
  system("d.erase")
}
```

#### **10. Calculate spatial heterogeneity metrics** From the new maps spatial heterogeneity metrics should be calculated.
```{r, heterogeneity metrics,results='hide',message=FALSE,eval=FALSE,comment='#'}
load("/data2/scripts/phenoutils/data/pheno_new.rda")
system("g.region raster=grid5km")

#-- Standard deviation
sd_maps<-NULL

for (i in 1:dim(pheno_new)[1]){
  print(i)
  # map names
  pheno_new[i,] %>% pull(tmp)->mapname
  # new map
  paste0(mapname,"_sd")->newmapname
  # calculate standard deviation
  paste0("r.resamp.stats input=",mapname," output=",paste0(mapname,"_sd")," method=stddev --o")->calc
  system(command=calc)
}
```
#### **11. Save metrics onto disk**
```{r,spatial coverage,results='hide',message=FALSE,eval=FALSE,comment='#'}
load("/data2/scripts/phenoutils/data/pheno_new.rda")

#-- Save diversity metrics onto disk 
# remove any phenometrics file, if present
system("rm -f /data2/tmp/phenometrics")
# remove mask, if present
system("r.mask -r")

for (i in 1:dim(pheno_new)[1]){
  # set region to 500m
  system("g.region raster=P1_2001_for")
  print(i)
  # map names
  pheno_new[i,] %>% pull(tmp)->mapname
  # new map
  paste0(mapname,"_count")->countname
  bind_rows(tibble(countname),count_maps)->count_maps
  # set map of interest to 1s
  system(paste0("r.mapcalc ","'tmp = int(",mapname," / ",mapname,")' --o"))
  # calculate count
  system("g.region raster=grid5km")
  system(command=paste0("r.resamp.stats input=tmp output=tmp1 method=sum --o"))
  # convert to integer  
  system(command=paste0("r.mapcalc ","'",countname," = int(tmp1)' --o"))
  # set mask
  system(command=paste0("r.mask raster=",countname,' maskcats="50 thru 200"'))
  # save info onto disk
  paste0(str_remove_all(countname,"_count"),"_sd")->outmap
  # save sd
  paste0("r.stats -An in=grid5km,",outmap," | awk '{print $0,",'"',outmap,'"',"}'"," >> /data2/tmp/phenometrics")->stats
  system(command=stats)
  # remove mask
  system("r.mask -r")
}
```


#### **13. Combine different info together** 
```{r,combine info,results='hide',message=FALSE,eval=FALSE,comment='#'}
load("/data2/scripts/phenoutils/data/lookup_pheno_sd.rda")
load("/data2/scripts/phenoutils/data/pftclim.rda")

# filter pixels which have at least 10 years of data
read_delim("/data2/tmp/phenometrics",col_names = F,delim = " ") %>%
  inner_join(lookup_pheno_sd1) %>%
  dplyr::select(-c(X3)) %>%
  rename(cat = X1, value = X2) %>% {.->>dat1} %>%
  group_by(metric,cat) %>%
  summarise(count=length(year)) %>%
  filter(count >= 10) %>%
  inner_join(dat1) %>%
  # filter by pfts
  inner_join(pftclim)->dat
saveRDS(dat,"/data2/scripts/pheno_analyses/dat.RDS")
readRDS("/data2/scripts/pheno_analyses/dat.RDS")->dat
dat %>%
  mutate(year=as.numeric(year)) %>%
  inner_join(tibble(year=2001:2016,year_scaled=as.numeric(scale(2001:2016)))) %>%
  group_by(cat,metric) %>%
  nest() ->dat1

save(dat1,file ="/data2/scripts/pheno_analyses/dat1.RDS")


library(furrr)

fit_mod<-function(x){
  pb$tick()$print()
  mod<-lm(value~year_scaled,data=x)
  tibble(beta=mod$coefficients[2])->res
  return(res)
}

pb<-progress_estimated(dim(dat1)[1])

plan(multiprocess,workers=6)
dat1 %>%
  mutate(mod=future_map(data,fit_mod))->modfit






tidied = map(mod, tidy)
unnest(tidied, .drop = TRUE)

saveRDS(modfit,file="/data2/scripts/pheno_analyses/modfit.RDS")
#readRDS("/data2/scripts/pheno_analyses/modfit")->trends

```
#### **12. Heterogeneity maps (averages)**
```{r,maps etc.,results='hide',message=FALSE,eval=FALSE,comment='#'}
# Create maps of standard deviation
system("g.region raster=Greenup_2001_season1")
system("g.region res=0.05")
for(i in 1:length(maps_original)){
  print(i)
  system(command =  paste0("r.resamp.stats in=",maps_original[i],"_for out=",maps_original[i],"_sd method=stddev --o"))
}

# create average maps of standard deviation across the whole period

# Peak
system(command=paste0("r.series input=",paste0("Peak_",2001:2016,"_season1_sd",collapse = ","),
                      " output=Peak_compo_sd method=median --o"))
system("r.out.gdal in=Peak_compo_sd out=/home/marco/Desktop/maps/Peak_sd.tif  createopt='COMPRESS=LZW'")
# Greenup
system(command=paste0("r.series input=",paste0("Greenup_",2001:2016,"_season1_sd",collapse = ","),
                      " output=Greenup_compo_sd method=median --o"))
system("r.out.gdal in=Greenup_compo_sd out=/home/marco/Desktop/maps/Greenup_sd.tif createopt='COMPRESS=LZW'")
# Length
system(command=paste0("r.series input=",paste0("Length_",2001:2016,"_season1_sd",collapse = ","),
                      " output=Length_compo_sd method=median --o"))
system("r.out.gdal in=Length_compo_sd out=/home/marco/Desktop/maps/Length_sd.tif createopt='COMPRESS=LZW'")

# Dormancy
system(command=paste0("r.series input=",paste0("Dormancy_",2001:2016,"_season1_sd",collapse = ","),
                      " output=Dormancy_compo_sd method=median --o"))

system("r.out.gdal in=Dormancy_compo_sd out=/home/marco/Desktop/maps/Dormancy_sd.tif createopt='COMPRESS=LZW'")

```


#### **12. Original metrics maps (averages)**
```{r,maps etc.1,results='hide',message=FALSE,eval=FALSE,comment='#'}
list.files("/data2/1degreemaps",full.names = T) %>%
  .[str_detect(.,"DO1_PE1_")]->file.l
stack(file.l)->dd
read_csv("/data2/forplotting.csv") %>%
  filter(metric!="DO2_PE2",metric!="PE2",metric!="GUP2_PE2") %>%
  inner_join(as_tibble(rastertodf(raster("/data2/grid5kmtif/grid5km.tif"))) %>%
               rename(cat = value)) %>%
  group_by(metric) %>%
  nest()->dat1 
dat1 %>%
  mutate(raster=map(data,~rasterFromXYZ(data.frame(.x$x,.x$y,.x$beta))))->rasters



res<-NULL

for (i in 1:3){ 
  print(i)
  writeRaster(rasters[i,]$raster[[1]],filename = "tmp.tif",overwrite=T)
  system("r.in.gdal in=tmp.tif out=tmp --o -o")
  system("g.region res=1 -pa")
  system("r.resamp.stats in=tmp out=tmp1 method=average --o")
  system("r.out.gdal in=tmp1 out=tmp1.tif --o")
  as_tibble(rastertodf(raster("tmp1.tif"))) %>%
    mutate(metric=rasters[i,]$metric) ->tmp
  bind_rows(tmp,res)->res
}

res %>%
  inner_join(tibble(metric=c("DO1_PE1","GUP1_PE1","P1"),
                    metric_f=factor(c("Peak_Dormancy","Greenup_Peak","Peak"),
                                    levels = c("Peak_Dormancy","Greenup_Peak","Peak")))) %>%
  ggplot(.,aes(x=x,y=y,fill=value))+geom_raster()+scale_fill_gradientn(colours = RColorBrewer::brewer.pal(9, 'Spectral'),limits = c(-2,2), oob = scales::squish)+theme_bw()+
  facet_wrap(~metric_f,ncol = 2)+theme(strip.text = element_text(size=14,color = "black",face = "bold"))->myp

ggsave(myp,filename = "/data2/figures/trendsmapped.png",dpi = 400, height = 10,width = 17)



```
#### **15. Filter pixels spatio-temporal coverage **
```{r, filter phenology pixels constant,results='hide',message=FALSE,eval=FALSE,comment='#'}
#system("rm -f /data2/tmp/pixelcount")
#touch /data2/tmp/pixelcount
load("/data2/scripts/phenoutils/data/pheno_new.rda")

pheno_new$tmp->maps.l
paste0(maps.l[i],"_spcoverage")->newmap


res<-NULL

for (i in 1:length(maps.l)){
  print(maps.l[i])
  # set region to raster
  system(command=paste0("g.region raster=",maps.l[i]))
  # set everything 1
  paste0(maps.l[i],"_spcoverage")->newmap
  system(command = paste0("r.mapcalc ","'",newmap," = ",maps.l[i],"/",maps.l[i],"' --o")) 
  # extract statistics
  system(command = paste0("r.stats -nc ", newmap),intern = T)->value
  # save results
  tibble(cell_count = as.numeric(str_split_fixed(value," ",n=2)[,2]),map = maps.l[i])->tmpdf
  tibble(map = maps.l[i])->tmpdf
  bind_rows(tmpdf,res)->res
}

# aggregate maps (create masks)
res %>%
  mutate(variable = str_split_fixed(map,"_",n=2)[,1])->res1

c("GUP1","DO1","P1")->var.l

# mask maps names
system("g.region raster=GUP1_PE1_2001")
maskcoverage<-NULL

for (i in 1:length(var.l)){
  print(var.l[i])
  res1 %>%
    filter(variable==var.l[i]) %>%
    pull(map)->maps
  # create mask
  system(command = paste0("r.mapcalc ",paste0("'",var.l[i],"_mask = "),paste0(maps,"_spcoverage",collapse = "+"),"' --o"))
  # record map name
  tibble(map = paste0(var.l[i],"_mask"), variable = var.l[i])->masktmp
  bind_rows(masktmp,maskcoverage)->maskcoverage
}

```
#### **16. Convert phenological datasets in day of the year **
```{r,convert maps into day of the year,results='hide',message=FALSE,eval=FALSE,comment='#'}
# get info on dates (so to reclass maps)
system(command = "g.region raster=Dormancy_2010_season1")
system("g.remove type=raster name=tmp -f")
system("g.remove type=raster name=tmp1 -f")

unixdates<-NULL
maps_original[!str_detect(maps_original,"Length")]->maps_original

for (i in 1:length(maps_original)){
  print(i)
  # get info
  system(command = paste0("r.stats -ln ",maps_original[i]),intern = T)->tmpstats
  # store results for reclassification
  tibble(day_unix = as.numeric(tmpstats),mapname = maps_original[i])->tmpres
  # save results
  bind_rows(tmpres,unixdates)->unixdates
  # ---- clean up
}

# convert into DOY
read_csv("/home/marco/Desktop/dates/unixdates.csv") %>%
  mutate(metric = str_split_fixed(mapname,"_",n=2)[,1],
         year = as.numeric(str_split_fixed(mapname,"_",n=3)[,2]),
         season = str_split_fixed(mapname,"_",n=3)[,3]) %>%
  mutate(date = as.Date(day_unix,origin = "1970-01-01"))  %>%
  mutate(year_fromdate = as.numeric(str_split_fixed(date,"-",n=2)[,1]),
         month_fromdate = as.numeric(str_split_fixed(date,"-",n=3)[,2]),
         day_fromdate = as.numeric(str_split_fixed(date,"-",n=3)[,3])) %>%
  mutate(dif_year = year - year_fromdate)  %>%
  mutate(DOY = yday(date))->dat

# reclassify Peak maps
years.l<-2001:2016  

for (i in 1:length(years.l)){
  print(i)
  dat %>%
    filter(metric=="Peak") %>%
    filter(year==years.l[i]) %>%
    dplyr::select(day_unix,DOY) %>%
    mutate(rcl = paste0(day_unix," = ",DOY)) %>%
    dplyr::select(rcl) %>%
    write.table(.,"/media/marco/birdsproject/phenology/tmp/rcl",row.names = F,
                quote = F,col.names = F)
  system(command=paste0("r.reclass in=Peak_",years.l[i],"_season1_for"," out=Peak_",years.l[i],"_season1_for_DOY rules=/media/marco/birdsproject/phenology/tmp/rcl --o"))
  system("rm -f /media/marco/birdsproject/phenology/tmp/rcl")
}

# create median composite using all pixels (forested areas regardless of temporal coverage)
system(command=paste0("r.series input=",paste0("Peak_",2001:2016,"_season1_for_DOY",collapse = ","),
                      " output=Peak_compo method=median --o"))
# create mask
system(command=paste0("r.series input=",paste0("Peak_",2001:2016,"_season1_for_binary",collapse = ","),
                      " output=Peak_mask method=sum --o"))
system("r.mapcalc 'Peak_mask1 = int(Peak_mask)'")
system("r.out.gdal in=Peak_mask1 out=/home/marco/Desktop/maps/Peak_mask.tif createopt='COMPRESS=LZW'")

# create median composite using pixels filtered by temporal coverage (at least 9 years)
system("r.mask raster=Peak_mask1 maskcats='9 thru 16'")
system(command=paste0("r.series input=",paste0("Peak_",2001:2016,"_season1_for_DOY",collapse = ","),
                      " output=Peak_compo9yrs method=median --o"))


system("g.region res=0.05")
system("r.resamp.stats in=Peak_2010_season1_for out=Peak_2010_sd method=stddev --o")

system("r.out.gdal in=Peak_2010_sd out=/home/marco/Desktop/maps/Peak_2010_sd.tif createopt='COMPRESS=LZW' --o")

system("g.region res=0.05")
system("r.resamp.stats in=Peak_compo out=Peak_sd method=stddev --o")
system("r.out.gdal in=Peak_sd out=/home/marco/Desktop/Peak_sd.tif createopt='COMPRESS=LZW' --o")



```

#### **17. Perform a number of checks on the maps **
```{r,check min max values of phenology maps,results='hide',message=FALSE,eval=FALSE,comment='#'}
# create a list of maps from existing ones within GRASS 
years.l<-2001:2016

forest_masked<-NULL

for (i in 1:length(years.l)){
  paste0("GUP1_",years.l[i],"_for")->GUP1
  paste0("GUP2_",years.l[i],"_for")->GUP2
  paste0("DO1_",years.l[i],"_for")->DO1
  paste0("DO2_",years.l[i],"_for")->DO2
  paste0("P1_",years.l[i],"_for")->PE1
  paste0("PE2_",years.l[i],"_for")->PE2
  tibble(map = GUP1) %>%
    bind_rows(tibble(map = GUP2)) %>%
    bind_rows(tibble(map = DO1)) %>%
    bind_rows(tibble(map = DO2)) %>% 
    bind_rows(tibble(map = PE1)) %>%
    bind_rows(tibble(map = PE2))->tmp
  bind_rows(tmp,forest_masked)->forest_masked
}

# get min and max values for maps

pull(forest_masked,map)->map.l

minmax<-NULL

for (i in 1:length(map.l)){
  print(i)
  system(command = paste0("r.info map=",map.l[i], " | grep Range") ,intern =T)->mapinfo
  tibble(min = as.numeric(str_replace_all(str_split_fixed(mapinfo,"=",n=4)[,2],"max|min","")),
         max = as.numeric(str_replace_all(str_split_fixed(mapinfo,"=",n=4)[,3],"[^[:alnum:]]","")),
         name = map.l[i])->tmp
  bind_rows(tmp,minmax)->minmax
}

lookup_pheno_sd %>%
  rename(name = X3 ) %>%
  mutate(name = str_replace_all(name,"_sd",""))->hh %>%
  inner_join(minmax)->dd

read_csv("/data2/tmp/maps_tmp.csv") %>%
  filter(season==1) %>%
  as.data.frame()
```
#### **3. Extract worldclim info **

```{r,worldclim,results='hide',message=FALSE,eval=FALSE,comment='#'}
# This code chunk is separate because it takes ages to run the above 
list.files("/home/marco/Desktop/phenology/climate",pattern=".tif",full.names = T)->files.l

system("r.mask -r")
system("g.region raster=forest_mask_5km")
system("r.mask raster=forest_mask_5km maskcats=1")

res<-NULL
for (i in 1:length(files.l)){
  print(i)
  # read into data into GRASS
  system(command = paste0("r.in.gdal in=",files.l[i]," out=",str_remove(str_remove(basename(files.l[i]),"wc2.1_2.5m_"),".tif")," --o"))
  system(command = paste0("r.out.gdal in=",str_remove(str_remove(basename(files.l[i]),"wc2.1_2.5m_"),".tif")," out=tmp.tif createopt='compress=LZW' --o"))
  system('gdalwarp -s_srs "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs" -t_srs "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs" -r near -of GTiff tmp.tif tmpr1.tif')
  # create dataframe
  as_tibble(rastertodf(raster("tmpr1.tif"))) %>%
    mutate(variable = str_remove(str_remove(basename(files.l[i]),"wc2.1_2.5m_"),".tif"))->df
  bind_rows(df,res)->res
  system("rm tmpr1.tif")
}
system("r.mask -r")
```


### **7 Post-processing GEE datasets**
```{r,summarise files,results='hide',message=FALSE,eval=FALSE,comment='#'}
raster("/home/marco/Desktop/phenology/tmp/forest_mask_5km.tif")->forestmask5km
system("r.in.gdal in=/home/marco/Desktop/phenology/tmp/forest_mask_5km.tif out=forest_mask_5km --o")

# list files
list.files("/mnt/data1tb/phenology/dataAprilv1",full.names = T,pattern = ".tif")->files.l 

# at least 10% NDVI
# southern hemisphere
read_files(files.l[str_detect(files.l,"SOUTH")] %>% .[str_detect(.,"SD75")],outmap = "SOUTH_SD75_median")->s75s_med
read_files(files.l[str_detect(files.l,"SOUTH")] %>% .[str_detect(.,"SD50")],outmap = "SOUTH_SD50_median")->s50s_med
read_files(files.l[str_detect(files.l,"SOUTH")] %>% .[str_detect(.,"SD25")],outmap = "SOUTH_SD25_median")->s25s_med
# global
read_files(files.l[str_detect(files.l,"10P")] %>% .[!str_detect(.,"SOUTH")] %>% .[str_detect(.,"SD75")],outmap = "SD75_P10_median")->s75_med
read_files(files.l[str_detect(files.l,"10P")] %>% .[!str_detect(.,"SOUTH")] %>% .[str_detect(.,"SD50")],outmap = "SD50_P10_median")->s50_med
read_files(files.l[str_detect(files.l,"10P")] %>% .[!str_detect(.,"SOUTH")] %>% .[str_detect(.,"SD25")],outmap = "SD25_P10_median")->s25_med

# create annual shifted maps
system("g.list rast | grep 10P | grep -v SOUTH",intern = TRUE)->north
system("g.list rast | grep 10P | grep SOUTH",intern = TRUE)->south
combine_sn_trends(insouth = south,innorth = north)


# Shifted Southern Hemisphere
combine_sn(south =s75s_med, north = s75_med, outmap = "SD DOY 75% SHIFTED (10% RULE)") %>%
  bind_rows(combine_sn(south =s50s_med, north = s50_med, outmap = "SD DOY 50% SHIFTED (10% RULE)")) %>%
  bind_rows(combine_sn(south =s25s_med, north = s25_med, outmap = "SD DOY 25% SHIFTED (10% RULE)")) %>%
  # 75th percentile
  bind_rows(percentile_df(infiles = files.l[str_detect(files.l,"PC_SD75")] %>% 
                            .[!str_detect(.,"SOUTH")] %>% .[!str_detect(.,"10P")]) %>%
              mutate(title="SD DOY 75%"))  %>%
  # 50th percentile
  bind_rows(percentile_df(infiles = files.l[str_detect(files.l,"PC_SD50")] %>% 
                            .[!str_detect(.,"SOUTH")] %>% .[!str_detect(.,"10P")]) %>%
              mutate(title="SD DOY 50%")) %>%
  # 25th percentile
  bind_rows(percentile_df(infiles = files.l[str_detect(files.l,"PC_SD25")] %>% 
                            .[!str_detect(.,"SOUTH")] %>% .[!str_detect(.,"10P")]) %>%
              mutate(title="SD DOY 25%")) %>%
  # 75th percentile 10% rule
  bind_rows(percentile_df(infiles = files.l[str_detect(files.l,"PC_SD75")] %>% 
                            .[!str_detect(.,"SOUTH")] %>% .[str_detect(.,"10P")]) %>%
              mutate(title="SD DOY 75% (10% RULE)"))  %>%  
  # 50th percentile 10% rule
  bind_rows(percentile_df(infiles = files.l[str_detect(files.l,"PC_SD50")] %>% 
                            .[!str_detect(.,"SOUTH")] %>% .[str_detect(.,"10P")]) %>%
              mutate(title="SD DOY 50% (10% RULE)")) %>%  
  # 25th percentile
  bind_rows(percentile_df(infiles = files.l[str_detect(files.l,"PC_SD25")] %>% 
                            .[!str_detect(.,"SOUTH")] %>% .[str_detect(.,"10P")]) %>%
              mutate(title="SD DOY 25%  (10% RULE)"))  %>%
  # Season length 
  bind_rows(percentile_df(infiles = files.l[str_detect(files.l,"SL_sd")]) %>% 
              mutate(title="Season length")) %>% 
  # Peak 
  bind_rows(percentile_df(infiles = files.l[str_detect(files.l,"Peak_sd")]) %>%
              mutate(title="Peak")) %>%
  # GUP
  bind_rows(percentile_df(infiles = files.l[str_detect(files.l,"GUP_sd")]) %>%
              mutate(title="Greenup")) %>%
  # Dormancy
  bind_rows(percentile_df(infiles = files.l[str_detect(files.l,"Dormancy_sd")]) %>%
              mutate(title="Dormancy")) %>%
  # NDVIMAX
  bind_rows(percentile_df(infiles = files.l[str_detect(files.l,"NDVIMAX")]) %>%
              mutate(title="NDVI Max"))->dat

saveRDS(dat,file = "/mnt/data1tb/phenology/rds/dat.RDS")
readRDS("/mnt/data1tb/phenology/rds/dat.RDS")->dat

# Frequency polygons
dat %>%
  rename(variable = title) %>%
  ggplot(.,aes(value,colour = variable))+
  geom_freqpoly(binwidth = 0.5,size=0.8)+theme_dark()+
  theme(axis.title = element_text(size = 24,face="bold"),
        axis.text = element_text(size=20,face="bold",colour="black"),
        legend.text = element_text(size=16),legend.title = 
          element_blank(),legend.position = "bottom")+xlab("SD Value")+ylab("Count")->frequency

# Save plot
png(filename="/home/marco/Desktop/phenology/figures/Fig1.png", 
    type="cairo",
    units="in", 
    width=12, 
    height=8, 
    pointsize=12, 
    res=300)
pushViewport(viewport(layout = grid.layout(1,1)))
print(frequency, vp = viewport(layout.pos.row = 1, layout.pos.col = 1))
dev.off()


#---- Correlation matrix

dat %>%
  mutate(title=str_replace_all(title," ","")) %>%
  spread(key=title,value=value) %>% 
  na.exclude()->dat1_w

ggcorrplot(cor(dat1_w[3:16]), hc.order = TRUE, type = "lower", lab = TRUE, insig = "blank")+
  theme(axis.text=element_text(size=15,colour = "black"))->cormat
ggsave(cormat,filename = "/mnt/data1tb/phenology/figures/Fig5.png",width = 9,
       height=8,dpi=400)


# ---- Maps 
library(RColorBrewer)

dat %>%
  mutate(plot_name = title) %>%
  group_by(plot_name) %>%
  nest() %>%
  mutate(res=map(data,plot_create)) %>%
  ungroup() %>% 
  mutate(fileout = str_replace_all(plot_name,"%","P"),
         fileout = str_replace_all(fileout,"\\)",""),
         fileout = str_replace_all(fileout,"\\(",""),
         fileout = str_replace_all(fileout," ","_"),
         fileout = paste0("/mnt/data1tb/phenology/figures/",fileout,".png")) %>% {.->> maps } %>%
  walk2(.x =.$fileout,.y=.$res,.f=~ggsave(filename=.x,plot=.y,width = 12,height=8))



#grid.arrange(maps[1,]$res[[1]],maps[2,]$res[[1]],
#             maps[3,]$res[[1]],maps[4,]$res[[1]],
#             maps[5,]$res[[1]],maps[6,]$res[[1]],
#             maps[7,]$res[[1]],maps[8,]$res[[1]],
#             ncol=2)->fp
#ggsave(fp,filename="/home/marco/Desktop/phenology/figures/Maps1.png",width = 8,height = 8.1,dpi=400)

#----- Heatmaps in climate space
#saveRDS(clim,file = "/home/marco/Desktop/phenology/rds/clim.RDS")
#res %>%
#  spread(key="variable",value="value")->clim
readRDS("/media/marco/marcodata19/rds/clim.RDS") %>%
  inner_join(dat) %>%
  inner_join(readRDS("/mnt/data1tb/phenology/rds/pristine_for.RDS"))->datclim  

#inner_join(readRDS("/home/marco/Desktop/phenology/rds/pft_prop.RDS"))->datclim 

#----  Heatmap pristine vs. non-pristine (main metrics)
datclim %>% 
  dplyr::filter(!grepl("10% RULE",title)) %>%
  dplyr::filter(!grepl("SHIFTED",title)) %>%
  mutate(plot_name = title) %>%  
  group_by(plot_name) %>%
  nest() %>%
  mutate(plot = map(data,~ggplot(data=.x,aes(x=bio_12,y=bio_1,z=value))+
                      stat_summary_2d(fun = function(x) {if(length(x[!is.infinite(x)])>=5)(mean(x))else(NA)},bins = 30,na.rm = FALSE)+
                      theme_minimal()+facet_grid(title~pristine)+
                      theme(legend.position = "right",legend.title = element_blank(),strip.text.x = element_text(size=17,face="bold"),strip.text.y = element_text(size=14,face="bold"),axis.text=element_text(size=12,
                                                                                                                                                                                                              colour="black"),axis.title = element_text(size = 15),strip.background = element_rect(colour = "white", fill = "white"),plot.title = element_text(hjust = 0.5,size=30,face="bold"))+xlab("")+ylab("")+
                      scale_fill_distiller(palette = "RdYlBu")))->res

grid.arrange(res[1,]$plot[[1]],res[2,]$plot[[1]],res[3,]$plot[[1]],
             res[4,]$plot[[1]],res[5,]$plot[[1]],res[6,]$plot[[1]],
             res[7,]$plot[[1]],res[8,]$plot[[1]],ncol=2)->myp
ggsave(myp,filename = "/mnt/data1tb/phenology/figures/Fig6v1.png",width = 12,height=11,dpi=400)

#----  Heatmap pristine vs. non-pristine (10% rule)

datclim %>% 
  dplyr::filter(title=="SD DOY 75%" | title=="SD DOY 50%" | title=="SD DOY 25%" | title=="SD DOY 50% (10% RULE)" | title=="SD DOY 25%  (10% RULE)" | title=="SD DOY 75% (10% RULE)") %>%
  mutate(plot_name = title) %>%  
  group_by(plot_name) %>%
  nest() %>%
  mutate(plot = map(data,~ggplot(data=.x,aes(x=bio_12,y=bio_1,z=value))+
                      stat_summary_2d(fun = function(x) {if(length(x[!is.infinite(x)])>=5)(mean(x))else(NA)},bins = 30,na.rm = FALSE)+
                      theme_minimal()+facet_grid(title~pristine)+
                      theme(legend.position = "right",legend.title = element_blank(),strip.text.x = element_text(size=17,face="bold"),strip.text.y = element_text(size=14,face="bold"),axis.text=element_text(size=12,
                                                                                                                                                                                                              colour="black"),axis.title = element_text(size = 15),strip.background = element_rect(colour = "white", fill = "white"),plot.title = element_text(hjust = 0.5,size=30,face="bold"))+xlab("")+ylab("")+
                      scale_fill_distiller(palette = "RdYlBu")))->res

grid.arrange(res[1,]$plot[[1]],res[4,]$plot[[1]],res[2,]$plot[[1]],
             res[5,]$plot[[1]],res[3,]$plot[[1]],res[6,]$plot[[1]],
             ncol=2)->myp
ggsave(myp,filename = "/mnt/data1tb/phenology/figures/Fig6v2.png",width = 13,height=11,dpi=400)

#----  Heatmap pristine vs. non-pristine (10% rule, shifted southern hemisphere)

datclim %>% 
  dplyr::filter(title=="SD DOY 75%" | title=="SD DOY 50%" | title=="SD DOY 25%" | title=="SD DOY 25% SHIFTED (10% RULE)" | title=="SD DOY 50% SHIFTED (10% RULE)" | title=="SD DOY 75% SHIFTED (10% RULE)") %>%
  mutate(plot_name = title) %>%  
  group_by(plot_name) %>%
  nest() %>%
  mutate(plot = map(data,~ggplot(data=.x,aes(x=bio_12,y=bio_1,z=value))+
                      stat_summary_2d(fun = function(x) {if(length(x[!is.infinite(x)])>=5)(mean(x))else(NA)},bins = 30,na.rm = FALSE)+
                      theme_minimal()+facet_grid(title~pristine)+
                      theme(legend.position = "right",legend.title = element_blank(),strip.text.x = element_text(size=17,face="bold"),strip.text.y = element_text(size=14,face="bold"),axis.text=element_text(size=12,
                                                                                                                                                                                                              colour="black"),axis.title = element_text(size = 15),strip.background = element_rect(colour = "white", fill = "white"),plot.title = element_text(hjust = 0.5,size=30,face="bold"))+xlab("")+ylab("")+
                      scale_fill_distiller(palette = "RdYlBu")))->res

grid.arrange(res[1,]$plot[[1]],res[4,]$plot[[1]],res[2,]$plot[[1]],
             res[5,]$plot[[1]],res[3,]$plot[[1]],res[6,]$plot[[1]],
             ncol=2)->myp
ggsave(myp,filename = "/mnt/data1tb/phenology/figures/Fig6v3.png",width = 13,height=11,dpi=400)




#----  Heatmap pristine vs. non-pristine (split by PFTs)

datclim %>%
  #dplyr::filter(!grepl("10% RULE",title)) %>%
  #dplyr::filter(!grepl("SHIFTED",title)) %>%
  inner_join(readRDS("/mnt/data1tb/phenology/rds/pft_prop.RDS") %>%
               filter(prop > 0.8)) %>%
  mutate(plot_name = title,PFT_title=PFT) %>%  
  group_by(plot_name,PFT_title) %>%
  nest()  %>%
  mutate(plot = map(data,~ggplot(data=.x,aes(x=bio_12,y=bio_1,z=value))+
                      stat_summary_2d(fun = function(x) {if(length(x[!is.infinite(x)])>=5)(mean(x))else(NA)},bins = 30,na.rm = FALSE)+
                      theme_minimal()+facet_grid(PFT~pristine)+
                      theme(legend.position = "right",legend.title = element_blank(),strip.text.x = element_text(size=17,face="bold"),strip.text.y = element_text(size=14,face="bold"),axis.text=element_text(size=12,
                                                                                                                                                                                                              colour="black"),axis.title = element_text(size = 15),strip.background = element_rect(colour = "white", fill = "white"),plot.title = element_text(hjust = 0.5,size=30,face="bold"))+xlab("Precipitation")+ylab("Temperature")+
                      scale_fill_distiller(palette = "RdYlBu")))->res1


plots_create<-function(tmp){
  title<-unique(tmp$title)
  grid.arrange(tmp[1,]$plot[[1]],tmp[2,]$plot[[1]],tmp[3,]$plot[[1]],tmp[4,]$plot[[1]],ncol=2,top =
                 textGrob(title,gp=gpar(fontsize=20,face="bold")))->myp
  fileout1<-paste0("/mnt/data1tb/phenology/figures/PFTs/",str_replace_all(unique(tmp$fileout),"%",""),"_PFT.png")
  ggsave(myp,filename = fileout1,width = 15,height=8,dpi=400)
}

library(grid)
res1 %>%
  #mutate(filename=plot_name) %>%
  mutate(fileout = str_replace_all(plot_name,"%","P"),
         fileout = str_replace_all(fileout,"\\)",""),
         fileout = str_replace_all(fileout,"\\(",""),
         fileout = str_replace_all(fileout," ","_")) %>%
  #mutate(filename=str_replace_all(filename," ","")) %>%
  mutate(title = plot_name) %>%
  group_by(plot_name) %>%
  nest() %>%
  mutate(ciao=map(data,plots_create))->hh

#----- Heatmaps in climate space with trends

# Greenup
trends_extract(infiles=system("g.list rast | grep GUP",intern=TRUE)) %>%
  mutate(title = "Greenup") %>%
  # Season Length
  bind_rows(trends_extract(infiles=system("g.list rast | grep SL",intern=TRUE)) %>%
              mutate(title = "Season Length")) %>%
  # Season Length
  bind_rows(trends_extract(infiles=system("g.list rast | grep Dormancy",intern=TRUE)) %>%
              mutate(title = "Dormancy")) %>%
  # Peak
  bind_rows(trends_extract(infiles=system("g.list rast | grep Peak",intern=TRUE)) %>%
              mutate(title = "Peak"))->trends_df


# NDVI MAX
bind_rows(trends_extract(infiles=system("g.list rast | grep NDVIMAX",intern=TRUE)) %>%
            mutate(title = "NDVI Max"))
# 25th Percentile
bind_rows(trends_extract(infiles=system("g.list rast | grep PC_SD25 | grep -v SOUTH | grep -v SHIFTED | grep -v 10P",intern=TRUE)) %>%
            mutate(title = "DOY 25%")) %>%
  # 75th Percentile
  bind_rows(trends_extract(infiles=system("g.list rast | grep PC_SD75 | grep -v SOUTH | grep -v SHIFTED | grep -v 10P",intern=TRUE)) %>%
              mutate(title = "DOY 75%")) %>%
  # 50th Percentile
  bind_rows(trends_extract(infiles=system("g.list rast | grep PC_SD50 | grep -v SOUTH | grep -v SHIFTED | grep -v 10P",intern=TRUE)) %>%
              mutate(title = "DOY 50%")) %>%
  # 75th Percentile (10% rule)
  bind_rows(trends_extract(infiles=system("g.list rast | grep SD7510P | grep -v SOUTH",intern=TRUE)) %>%
              mutate(title = "SD DOY 75% (10% RULE)"))  %>%
  # 50th Percentile (10% rule)
  bind_rows(trends_extract(infiles=system("g.list rast | grep SD5010P | grep -v SOUTH",intern=TRUE)) %>%
              mutate(title = "SD DOY 50% (10% RULE)"))  %>%
  # 25th Percentile (10% rule)
  bind_rows(trends_extract(infiles=system("g.list rast | grep SD2510P | grep -v SOUTH",intern=TRUE)) %>%
              mutate(title = "SD DOY 25% (10% RULE)"))  %>%
  # 75th Percentile 10% rule (shifted hemisphere)
  bind_rows(trends_extract(infiles=system("g.list rast | grep SD75 | grep SHIFTED ",intern=TRUE)) %>%
              mutate(title = "SD DOY 75% SHIFTED (10% RULE)"))  %>%
  # 50th Percentile 10% rule  (shifted hemisphere)
  bind_rows(trends_extract(infiles=system("g.list rast | grep SD50 | grep SHIFTED ",intern=TRUE)) %>%
              mutate(title = "SD DOY 50% SHIFTED (10% RULE)"))  %>%
  # 25th Percentile 10% rule  (shifted hemisphere)
  bind_rows(trends_extract(infiles=system("g.list rast | grep SD25 | grep SHIFTED ",intern=TRUE)) %>%
              mutate(title = "SD DOY 25% SHIFTED (10% RULE)"))->trends_df


# create final dataframe
readRDS("/mnt/data1tb/phenology/rds/clim.RDS") %>%
  inner_join(trends_df)  %>%
  #inner_join(kba_for)->trendclim
  inner_join(readRDS("/mnt/data1tb/phenology/rds/pristine_for.RDS"))->trendclim  


# all variables (excluding shifted hemisphere and 10% NDVI)
trendclim %>%
  mutate(plot_name = title) %>%  
  group_by(plot_name) %>%
  #mutate(value=scales::rescale(value,to=c(-1,1))) %>%
  nest() %>%
  mutate(plot = map(data,~ggplot(data=.x,aes(x=bio_12,y=bio_1,z=value))+
                      stat_summary_2d(fun = function(x) {if(length(x[!is.infinite(x)])>=5)(mean(x))else(NA)},bins = 30,na.rm = FALSE)+
                      theme_minimal()+facet_grid(title~pristine)+
                      theme(legend.position = "right",legend.title = element_blank(),strip.text.x = element_text(size=17,face="bold"),strip.text.y = element_text(size=14,face="bold"),axis.text=element_text(size=12,
                                                                                                                                                                                                              colour="black"),axis.title = element_text(size = 15),strip.background = element_rect(colour = "white", fill = "white"),plot.title = element_text(hjust = 0.5,size=30,face="bold"))+xlab("")+ylab("")+
                      scale_fill_gradient2(low ="blue", mid = "white",high ="red")))->res

# Everything but 10% rule and shifted
grid.arrange(res[1,]$plot[[1]],res[2,]$plot[[1]],res[3,]$plot[[1]],
             res[4,]$plot[[1]],res[5,]$plot[[1]],res[6,]$plot[[1]],
             res[7,]$plot[[1]],res[8,]$plot[[1]],ncol=2)->myp

grid.arrange(res[1,]$plot[[1]],res[2,]$plot[[1]],res[3,]$plot[[1]],
             res[4,]$plot[[1]],ncol=2)->myp
ggsave(myp,filename = "/mnt/data1tb/phenology/figures/trendsv1/Fig3yearslice.png",width = 12,height=8,dpi=400)
# 10% rule
grid.arrange(res[5,]$plot[[1]],res[11,]$plot[[1]],res[7,]$plot[[1]],
             res[10,]$plot[[1]],res[6,]$plot[[1]],res[9,]$plot[[1]],
             ncol=2)->myp
ggsave(myp,filename = "/mnt/data1tb/phenology/figures/trends/Fig7v1.png",width = 12,height=11,dpi=400)
# shifted hemispheres
grid.arrange(res[5,]$plot[[1]],res[14,]$plot[[1]],res[7,]$plot[[1]],
             res[13,]$plot[[1]],res[6,]$plot[[1]],res[12,]$plot[[1]],
             ncol=2)->myp
ggsave(myp,filename = "/mnt/data1tb/phenology/figures/trends/Fig7v2.png",width = 12,height=11,dpi=400)


# trends by PFTs
trendclim %>%
  inner_join(readRDS("/mnt/data1tb/phenology/rds/pft_prop.RDS") %>%
               filter(prop > 0.8)) %>%
  mutate(plot_name = title,PFT_title=PFT) %>%  
  group_by(plot_name,PFT_title) %>%
  nest() %>%
  mutate(plot = map(data,~ggplot(data=.x,aes(x=bio_12,y=bio_1,z=value))+
                      stat_summary_2d(fun = function(x) {if(length(x[!is.infinite(x)])>=5)(mean(x))else(NA)},bins = 30,na.rm = FALSE)+
                      theme_minimal()+facet_grid(PFT~pristine)+
                      theme(legend.position = "right",legend.title = element_blank(),strip.text.x = element_text(size=15,face="bold"),strip.text.y = element_text(size=10,face="bold"),axis.text=element_text(size=9,
                                                                                                                                                                                                              colour="black"),axis.title = element_text(size = 15),strip.background = element_rect(colour = "white", fill = "white"),plot.title = element_text(hjust = 0.5,size=30,face="bold"))+xlab("")+ylab("")+
                      scale_fill_gradient2(low ="blue", mid = "white",high ="red"))) %>%
  mutate(fileout = str_replace_all(plot_name,"%","P"),
         fileout = str_replace_all(fileout,"\\)",""),
         fileout = str_replace_all(fileout,"\\(",""),
         fileout = str_replace_all(fileout," ","_")) %>%
  mutate(title = plot_name) %>%
  group_by(plot_name) %>%
  nest() %>% 
  mutate(result=map(data,~grid.arrange(.[1,]$plot[[1]],.[2,]$plot[[1]],.[3,]$plot[[1]],.[4,]$plot[[1]],ncol=2),top =textGrob(title,gp=gpar(fontsize=20,face="bold")))) %>%
  mutate(fileout = str_replace_all(plot_name,"%","P"),
         fileout = str_replace_all(fileout,"\\)",""),
         fileout = str_replace_all(fileout,"\\(",""),
         fileout = str_replace_all(fileout," ","_"),
         fileout = paste0("/mnt/data1tb/phenology/figures/trends/",fileout,"_PFT.png")) %>% {.->> trends_pfts } %>%
  walk2(.x=.$fileout,.y=.$result,.f=~ggsave(filename=.x,plot=.y,width = 9,height=6,dpi=400))

# Proper trends estimated using lm
# Greenup
get_allyears(infiles=system("g.list rast | grep GUP",intern=TRUE)) %>%
  mutate(title = "Greenup") %>%
  # Season Length
  bind_rows(get_allyears(infiles=system("g.list rast | grep SL",intern=TRUE)) %>%
              mutate(title = "Season Length")) %>%
  # Season Length
  bind_rows(get_allyears(infiles=system("g.list rast | grep Dormancy",intern=TRUE)) %>%
              mutate(title = "Dormancy")) %>%
  # Peak
  bind_rows(get_allyears(infiles=system("g.list rast | grep Peak",intern=TRUE)) %>%
              mutate(title = "Peak"))->data_allyears
saveRDS(data_allyears,file = "/mnt/data1tb/phenology/rds/datallyears.RDS")

data_allyears %>%
  group_by(x,y,title) %>%
  mutate(year = as.numeric(scale(year))) %>%
  nest() %>%
  mutate(res = map(data,~broom::tidy(lm(value~year,data=.)))) %>%
  unnest(cols=res)->modres
beep(sound = 8, expr = NULL)


# create final dataframe
readRDS("/mnt/data1tb/phenology/rds/modres") %>%
  #modres %>%
  filter(term=="year") %>%
  filter(p.value < 0.05) %>%
  inner_join(readRDS("/mnt/data1tb/phenology/rds/clim.RDS"))  %>%
  #inner_join(kba_for)->trendclim
  inner_join(readRDS("/mnt/data1tb/phenology/rds/pristine_for.RDS"))->trendclim  


# all variables (excluding shifted hemisphere and 10% NDVI)
trendclim %>%
  #filter(pristine=="pristine") %>%
  mutate(plot_name = title) %>%  
  group_by(plot_name) %>%
  #mutate(value=scales::rescale(value,to=c(-1,1))) %>%
  nest() %>%
  mutate(plot = map(data,~ggplot(data=.x,aes(x=bio_12,y=bio_1,z=estimate))+
                      stat_summary_2d(fun = function(x) {if(length(x[!is.infinite(x)])>=5)(mean(x))else(NA)},bins = 30,na.rm = FALSE)+
                      theme_minimal()+facet_grid(title~pristine)+
                      theme(legend.position = "right",legend.title = element_blank(),strip.text.x = element_text(size=17,face="bold"),strip.text.y = element_text(size=14,face="bold"),axis.text=element_text(size=12,
                                                                                                                                                                                                              colour="black"),axis.title = element_text(size = 15),strip.background = element_rect(colour = "white", fill = "white"),plot.title = element_text(hjust = 0.5,size=30,face="bold"))+xlab("")+ylab("")+
                      scale_fill_gradient2(low ="blue", mid = "white",high ="red")))->res

grid.arrange(res[1,]$plot[[1]],res[2,]$plot[[1]],res[3,]$plot[[1]],
             res[4,]$plot[[1]],ncol=2)->myp

ggsave(myp,filename = "/mnt/data1tb/phenology/figures/trendsv1/FigLinearModelsPVALUE.png",width = 12,height=9,dpi=400)


# biomes info
system("v.to.rast in=ecoregions use=attr attribute_column=WWF_MHTNUM out=ecoregions")
system("r.out.gdal in=ecoregions out=tmp.tif createopt='COMPRESS=DEFLATE' --o")
# reproject file
system("rm -f tmpr1.tif")
system('gdalwarp -s_srs "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs" -t_srs "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs" -r near -of GTiff tmp.tif tmpr1.tif')
# import file
as_tibble(rastertodf(raster("tmpr1.tif"))) %>%
  rename(WWF_MHTNUM = value) %>%
  inner_join(unique(as_tibble(st_read("/home/marco/Desktop/ecoregions1/tnc_terr_ecoregions.shp")) %>%
                      dplyr::select(WWF_MHTNUM,WWF_MHTNAM) %>%
                      filter(WWF_MHTNAM %in% c("Tropical and Subtropical Moist Broadleaf Forests","Tropical and Subtropical Dry Broadleaf Forests",
                                               "Temperate Broadleaf and Mixed Forests","Mediterranean Forests, Woodlands and Scrub",
                                               "Tropical and Subtropical Coniferous Forests","Temperate Conifer Forests","Boreal Forests/Taiga"))))->ecoreg
saveRDS(ecoreg,file = "/mnt/data1tb/phenology/rds/ecoreg.RDS")

# time series
readRDS("/mnt/data1tb/phenology/rds/datallyears.RDS") %>%
  inner_join(readRDS("/mnt/data1tb/phenology/rds/ecoreg.RDS")) %>%
  inner_join(readRDS("/mnt/data1tb/phenology/rds/pristine_for.RDS"))->dat

dat %>%
  #filter(pristine=="Non-pristine") %>%
  group_by(title,year,WWF_MHTNAM,pristine) %>%
  summarise(count =n()) %>%d
  filter(count > 200) %>%
  ungroup() %>%
  dplyr::select(WWF_MHTNAM,pristine) %>%
  unique() %>%
  inner_join(dat) %>% 
  group_by(title,year,WWF_MHTNAM,pristine) %>% 
  #summarise(mean = exp(mean(log(value)))) %>%
  summarise(mean = mean(value)) %>%
  group_by(title,WWF_MHTNAM,pristine) %>%
  mutate(mean = scales::rescale(mean,to=c(0,1))) %>%
  ungroup() %>% {.->>tmp} %>% 
  mutate(WWF_MHTNAM = str_wrap(WWF_MHTNAM,width = 15)) %>%
  #mutate(WWF_MHTNAM1=WWF_MHTNAM,title1=title) %>%
  group_by(pristine) %>%
  nest() %>%
  mutate(plot = map(data,~ggplot(.,aes(x=year,y=mean))+geom_line(size=0.6)+geom_point()+facet_grid(WWF_MHTNAM~title)+
                      theme_bw()+theme(strip.text = element_text(face="bold",size=10))+ylab("Mean of SD")+guides(colour=guide_legend(title="BIOME"))+
                      geom_smooth(method="lm"))) %>%
  mutate(filename = paste0("/mnt/data1tb/phenology/figures/trendsv1/",str_remove(pristine,"-"),".png")) %>%
  walk2(.x=.$filename,.y=.$plot,.f=~ggsave(filename = .x,plot=.y,width = 9,height = 9,dpi=400))

walk2(.x=.$fileout,.y=.$result,.f=~ggsave(filename = .x,plot =.y,width = 9,height = 6,dpi=400))


```
### **8 Primary forest layer**
```{r,primary forest mask,results='hide',message=FALSE,eval=FALSE,comment='#'}
# read in intact forest layer
system("v.in.ogr in=/home/marco/Desktop/phenology/primaryforests/ifl_2016.shp out=pristine_for")
system("g.region raster=forest_mask_5km")
system("v.to.rast in=pristine_for use=cat out=pristine_tmp --o")
system("r.mapcalc 'pristine_for = pristine_tmp/pristine_tmp' --o")
# create forest map (combined of pristine and pristine forests,1 = pristine,2 non pristine)
system("r.mask raster=pristine_for maskcats=1 -i")
system("g.region raster=forest_mask_5km")
system("r.mapcalc 'nopristine_for = forest_mask_5km' --o")
system("r.mask -r")
system("r.mapcalc 'nopristine_for1 = nopristine_for+1' --o")
system("r.patch in=nopristine_for1,pristine_for out=pristine_mask")
# save file
system("rm tmpr1.tif")
system("r.out.gdal in=pristine_mask out=tmp.tif createopt='compress=LZW' --o")
system('gdalwarp -s_srs "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs" -t_srs "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs" -r near -of GTiff tmp.tif tmpr1.tif')
# read in file
as_tibble(rastertodf(raster("tmpr1.tif"))) %>% 
  rename(pristine = value) %>%
  mutate(pristine=ifelse(pristine==1,"Pristine","Non-pristine"))->pristine_for
saveRDS(pristine_for,file="/mnt/data1tb/phenology/rds/pristine_for.RDS")
```
